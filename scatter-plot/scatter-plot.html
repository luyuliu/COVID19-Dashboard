<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="./d3.min.js"></script>

<!-- Create a div where the graph will take place -->
<div id="graph-div" style="float: left"></div>
<div style="float: left">
    <div class="dropdown">
        <select onchange="updateGraph()" id = "cases_ind">
            <option value = "confirmed">Total Confirmed (Person)</option>
            <option value = "deaths">Total Deaths (Person)</option>
        </select></div>
    <div class="dropdown">
        <select onchange="updateGraph()" id = "se_ind">
            <option value = "pct_chldn">Percentage of Children (Aged 0 - 14) (%)</option>
            <option value = "pct_youth">Percentage of Youth (Aged 15 - 24) (%)</option>
            <option value = "pct_ad">Percentage of Adults (Aged 25 - 64) (%)</option>
            <option value = "pct_sr">Percentage of Seniors (Aged above 64) (%)</option>
            <option value = "pct_wht">Percentage of White Population (%)</option>
            <option value = "pct_nwht">Percentage of Non-White Population (%)</option>
            <option value = "med_hh_inc">Median Household Income (U.S. Dollar)</option>
            <option value = "pct_blw_pov_rt">Percentage of Population Below Poverty Line (%)</option>
        </select></div>
</div>

<style>
.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.dot {
  stroke: #000;
}
</style>

<script>
var se_ind = document.querySelector('#se_ind').value;
var cases_ind = document.querySelector('#cases_ind').value;

function drawGraph(se_ind, cases_ind) {
	d3.select("#graph-div").selectAll("svg").remove();
	// set up layout
	var margin = {top: 20, right: 20, bottom: 50, left: 60},
	    width = 720 - margin.left - margin.right,
	    height = 375 - margin.top - margin.bottom;

	color = d3.scaleOrdinal(d3.schemeCategory10);

	// add the graph canvas to the body of the webpage
	var svg = d3.select("#graph-div").append("svg")
	    .attr("width", width + margin.left + margin.right)
	    .attr("height", height + margin.top + margin.bottom)
	    .append("g")
	    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


	// load data
	d3.csv("http://192.168.1.12:8080/ACSDP5Y2018.compiled_county_edited.csv").then(function(data_ind) { // please replace this with your file path
		data_ind.forEach(function(d) {
			d.TOT_POP = +d.TOT_POP;
			d.TOT_HH = +d.TOT_HH;
			d.PCT_CHLDN = +d.PCT_CHLDN;
			d.PCT_YOUTH = +d.PCT_YOUTH;
			d.PCT_AD = +d.PCT_AD;
			d.PCT_SR = +d.PCT_SR;
			d.PCT_WHT = +d.PCT_WHT;
			d.PCT_NWHT = +d.PCT_NWHT;
			d.MED_HH_INC = +d.MED_HH_INC;
			d.PCT_BLW_POV_RT = +d.PCT_BLW_POV_RT;
		});

		d3.json("http://192.168.1.12:8080/raw-covid-19-data-us-counties-usafacts.json").then(function(data_cases) { // please replace this with your file path
			var data = convert_county_data(data_ind, data_cases);
			
			// set up x
			var x_value = function(d) {
			    if (se_ind == 'pct_chldn'){
			        return d.PCT_CHLDN;
			    } else if (se_ind == 'pct_youth'){
			        return d.PCT_YOUTH;
			    } else if (se_ind == 'pct_ad'){
			        return d.PCT_AD;
			    } else if (se_ind == 'pct_sr'){
			        return d.PCT_SR;
			    } else if (se_ind == 'pct_wht'){
			        return d.PCT_WHT;
			    } else if (se_ind == 'pct_nwht'){
			        return d.PCT_NWHT;
			    } else if (se_ind == 'med_hh_inc'){
			        return d.MED_HH_INC;
			    } else if (se_ind == 'pct_blw_pov_rt'){
			        return d.PCT_BLW_POV_RT;
			    }
			};

			var x_text = function(d) {
			    if (se_ind == 'pct_chldn'){
			        return 'Percentage of Children (Aged 0 - 14) (%)';
			    } else if (se_ind == 'pct_youth'){
			        return 'Percentage of Youth (Aged 15 - 24) (%)';
			    } else if (se_ind == 'pct_ad'){
			        return 'Percentage of Adults (Aged 25 - 64) (%)';
			    } else if (se_ind == 'pct_sr'){
			        return 'Percentage of Seniors (Aged above 64) (%)';
			    } else if (se_ind == 'pct_wht'){
			        return 'Percentage of White Population (%)';
			    } else if (se_ind == 'pct_nwht'){
			        return 'Percentage of Non-white Population (%)';
			    } else if (se_ind == 'med_hh_inc'){
			        return 'Median Household Income (U.S. Dollar)';
			    } else if (se_ind == 'pct_blw_pov_rt'){
			        return 'Percentage of Population Below Poverty Line (%)';
			    }
			};

			var x = d3.scaleLinear().range([0, width]),
			    xMap = function(d) { return x(x_value(d));},
			    xAxis = d3.axisBottom(x);


			// set up y
			var y_value = function(d) {
			    if (cases_ind == 'confirmed'){
			        return d.CONFIRMED;
			    } else if (cases_ind == 'deaths'){
			        return d.DEATHS;
			    }
			};

			var y_text = function(d) {
			    if (cases_ind == 'confirmed'){
			        return 'Total Confirmed (Person)';
			    } else if (cases_ind == 'deaths'){
			        return 'Total Deaths (Person)';
			    }
			};

			var y = d3.scaleLinear().range([height, 0]),
			    yMap = function(d) { return y(y_value(d));},
			    yAxis = d3.axisLeft(y);;

			data.forEach(function(d) {
			    if (se_ind == 'pct_chldn'){
			        d.PCT_CHLDN = +d.PCT_CHLDN;
			    } else if (se_ind == 'pct_youth'){
			        d.PCT_YOUTH = +d.PCT_YOUTH;
			    } else if (se_ind == 'pct_ad'){
			        d.PCT_AD = +d.PCT_AD;
			    } else if (se_ind == 'pct_sr'){
			        d.PCT_SR = +d.PCT_SR;
			    } else if (se_ind == 'pct_wht'){
			        d.PCT_WHT = +d.PCT_WHT;
			    } else if (se_ind == 'pct_nwht'){
			        d.PCT_NWHT = +d.PCT_NWHT;
			    } else if (se_ind == 'med_hh_inc'){
			        d.MED_HH_INC = +d.MED_HH_INC;
			    } else if (se_ind == 'pct_blw_pov_rt'){
			        d.PCT_BLW_POV_RT = +d.PCT_BLW_POV_RT;
			    }
			    
			    if (cases_ind == 'confirmed'){
			        d.CONFIRMED = +d.CONFIRMED;
			    } else if (cases_ind == 'deaths'){
			        d.DEATHS = +d.DEATHS;
			    }
		    });

			// set axis domains
			x.domain([d3.min(data, x_value) - 1, d3.max(data, x_value) + 1]);

			var y_array = data.map(y_value);
			y_array.sort(d3.ascending);
			var q1 = d3.quantile(y_array, 0.25),
			    q3 = d3.quantile(y_array, 0.75),
			    iqr = q3 - q1,
			    maxValue = q3 + iqr * 8;
			y.domain([d3.min(data, y_value) - 1, maxValue - 1]);


			// x-axis
			svg.append("g")
				.attr("class", "x axis")
				.call(xAxis)
				.attr("transform", "translate(0," + height + ")")
			svg.append("text")
				.attr("transform", "translate(0," + height + ")")
				.attr("class", "label")
				.attr("x", width)
				.attr("y", margin.top + 20)
				.style("text-anchor", "end")
				.text(x_text);

			// y-axis
			svg.append("g")
				.attr("class", "y axis")
				.call(yAxis)
			svg.append("text")
				.attr("class", "label")
				.attr("transform", "rotate(-90)")
				.attr("x", -margin.top)
				.attr("y", -margin.left + 18)
				.style("text-anchor", "end")
				.text(y_text)

			// draw dots
			svg.selectAll(".dot")
			  .data(data)
			  .enter().append("circle")
			  .attr("class", function (d) { return "dot " + d.stateFIPS} )
			  .attr("cx", xMap)
			  .attr("cy", yMap)
	  		  .attr("r", function(d) { 
	              if (d.stateFIPS == 39) { // please replace the fixed stateFIPS with the selected one
	                  return 3;
	              } else {
	                  return 2;}
	               })
			  .style("opacity", function(d) { 
			              if (d.stateFIPS == 39) { // please replace the fixed stateFIPS with the selected one
			                  return 1.0;
			              } else {
			                  return 0.5;}
			               })
			  .style("fill", function(d) { 
			              if (d.stateFIPS == 39) { // please replace the fixed stateFIPS with the selected one
			                  return "gold";
			              } else {
			                  return "lightgrey";}
			               });


			// draw legend
			var legend = svg.selectAll(".legend")
			  .data(color.domain())
			  .enter().append("g")
			  .attr("class", "legend")
			  .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });


			// draw legend colored rectangle
			legend.append("rect")
			  .attr("x", width - 18)
			  .attr("width", 18)
			  .attr("height", 18)
			  .style("fill", color);


			// draw legend text
			legend.append("text")
			  .attr("x", width - 24)
			  .attr("y", 9)
			  .attr("dy", ".35em")
			  .style("text-anchor", "end")
			  .text(function(d) { return d; });
		});
	});
}

drawGraph(se_ind, cases_ind);

function updateGraph() {
	var se_ind = document.querySelector('#se_ind').value;
	var cases_ind = document.querySelector('#cases_ind').value;
	drawGraph(se_ind, cases_ind);
}

// Link county-level datasets
function convert_county_data(ses, cases) {
    var data = [],
        keys = Object.keys(ses);
    
    keys.forEach(function(key) {
        var item = {},
            obj = ses[key];

        item['countyFIPS'] = obj['countyFIPS'],
        item['county'] = obj['county'],
        item['stateFIPS'] = obj['stateFIPS'],
        item['PCT_CHLDN'] = obj['PCT_CHLDN'],
        item['PCT_YOUTH'] = obj['PCT_YOUTH'], 
        item['PCT_AD'] = obj['PCT_AD'], 
        item['PCT_SR'] = obj['PCT_SR']
        item['PCT_WHT'] = obj['PCT_WHT'];
        item['PCT_NWHT'] = obj['PCT_NWHT'];
        item['MED_HH_INC'] = obj['MED_HH_INC'];
        item['PCT_BLW_POV_RT'] = obj['PCT_BLW_POV_RT'];
        
        item['CONFIRMED'] = null,
        item['DEATHS'] = null,
        keys_2 = Object.keys(cases);
        keys_2.forEach(function(key) {
            var item_2 = {},
                obj_2 = cases[key];
            
            if (obj_2['countyFIPS'] == item['countyFIPS']){
                item['CONFIRMED'] = obj_2['confirmed'][obj_2['confirmed'].length - 1],
                item['DEATHS'] = obj_2['deaths'][obj_2['deaths'].length - 1]; 
            }
        });
    data.push(item);
    });
    return data;
}

</script>